--- BELOW QUERY WILL RETURN THE REPORT WITH MEMBER, PROVIDER, TOTAL NUMBER OF CLAIMS AND LATEST SERVICE DATE.
--- THE REPORT RETURNED WILL SHOW THE ASSIGNMENT OF PROVIDERS TO A MEMBER BASED ON MAXIMUM NUMBER OF CLAIMS RECEIVED FROM A PROVIDER.
-- AND IF TWO PROVIDERS SUBMITTED SAME NUMBER OF CLAIMS FOR A MEMBER, THEN PROVIDER ASSIGNMENT WILL BE DETERMINED BY WHICH PROVIDER PROVIDED LASTEST SERVICE (CLAIM DATE OF SERVICE)



----- BELOW WE WILL CREATE A TEMPORARY TABLE WITH MEMBERID, PROVIDERID, TOTOAL COUNT OF CLAIMS AND LATEST SERVICE DATE.
WITH T1 AS
(
SELECT MEMBERID, PROVIDERID, COUNT(DISTINCT CLAIMID) AS COUNT_OF_CLAIMS
FROM CLAIMS C
WHERE 1=1
AND ServiceDateFrom >= '2022-01-01'
AND ServiceDateFrom <= '2022-12-31'
AND Status = 'TBP'
GROUP BY MEMBERID, PROVIDERID
),
T2 AS
(
SELECT MEMBERID, PROVIDERID, MAX(ServiceDateFrom) AS MAX_SERVICE_DATE
FROM CLAIMS C
WHERE 1=1
AND ServiceDateFrom >= '2022-01-01'
AND ServiceDateFrom <= '2022-12-31'
AND Status = 'TBP'
GROUP BY MEMBERID, PROVIDERID
)
SELECT T1.MEMBERID, T1.PROVIDERID, T1.COUNT_OF_CLAIMS, T2.MAX_SERVICE_DATE
INTO #TEMP_REPORT1
FROM T1
JOIN T2
ON T1.MemberId = T2.MemberId
AND T1.ProviderId = T2.ProviderId
WHERE 1=1


--- OVER HERE,THE INNERMOST QUERY IN JOIN CONDITION WILL RETURN THE MEMBER RECORD WHICH HAVE HIGHEST COUNT OF CLAIMS
---THE SECOND LEVEL OF INNER QUERY WILL RETURN THE RECORD WHICH HAVE LATEST SERVICE DATE USING ROW_NUMBER FUNCTION.



SELECT X.*
FROM
(
SELECT a.*, ROW_NUMBER() OVER(PARTITION BY a.MEMBERID ORDER BY MAX_SERVICE_DATE DESC) AS ROW_NUM_SERVICE_DATE
FROM #TEMP_REPORT1 A
JOIN ( SELECT MemberId, MAX(COUNT_OF_CLAIMS) AS MAX_COUNT_OF_CLAIMS
FROM #TEMP_REPORT1
GROUP BY MemberId
) b
ON a.MemberId = b.MemberId and a.COUNT_OF_CLAIMS =b.MAX_COUNT_OF_CLAIMS
) X
WHERE 1=1
AND X.ROW_NUM_SERVICE_DATE = 1



---THE FINAL REPORT WILL LOOK LIKE THIS
-- EXAMPLE:
-- MEMBER 111 HAVE MULTIPLE PROVIDER SUBMITIGN SAME NUMBER OF CLAIMS (LETS SAY 1 CLAIM), THE PROVIDER ASSIGNED WILL BE THE ONE WHO SENT THE LATEST CLAIMS.
-- MEMBER 22 HAVE PROVIDER A - SUBMITTING 5 CLAIMS WITH LATEST DOS AS 05/01/2021, WHEREAS PROVIDER B SUBMITTING 4 CLAIMS WITH LATEST DOS AS 06/01/2021. THEN MEMBER 22 WILL HAVE PROVIDER A ASSIGNED.
-- IN CASES WHERE MEMBER HAVE TWO PROVIDER SUBMITTED SAME NUMBER OF CLAIMS AND LATEST DOS IS ALSO SAME, PROVIDER ASSIGNMENT IS BEING PICKED RANDOMLY AS PER ROW_NUMBER FUNCTION.

